#!/bin/sh
PATH=/bin:/usr/bin:/usr/local/bin:/usr/local/sbin
export PATH

QMAILDUID=`id -u qmaild`
NOFILESGID=`id -g qmaild`
svclist="apache php-fpm"

case "$1" in
  start)
    echo "Starting webserver..."
    for svc in $svclist ; do
        if svok /service/$svc ; then
            svc -u /service/$svc
        else
            echo $svc service not running
        fi
    done
    ;;
  stop)
    echo "Stopping webserver..."
    for svc in $svclist ; do
      echo " $svc"
      svc -d /service/$svc
    done
    ;;
  stat)
    for svc in $svclist ; do
      svstat /service/$svc
    ;;
  pause)
    for svc in $svclist ; do
      echo "Pausing $svc"
      svc -p /service/$svc
    done
    ;;
  cont)
    for svc in $svclist ; do
      echo "Continuing $svc"
      svc -c /service/$svc
    done
    ;;
  restart)
    echo "Restarting webserver:"
    for svc in $svclist ; do
      echo "* Stopping $svc."
      svc -d /service/$svc
    done
    for svc in $svclist ; do
      echo "* Restarting $svc."
      svc -u /service/$svc
    done
    ;;
  help)
    cat <<HELP
    stop -- stops mail service (smtp connections refused, nothing goes out)
   start -- starts mail service (smtp connection accepted, mail can go out)
   pause -- temporarily stops mail service (connections accepted, nothing leaves)
    cont -- continues paused mail service
    stat -- displays status of mail service
     cdb -- rebuild the tcpserver cdb file for smtp
 restart -- stops and restarts smtp, sends qmail-send a TERM & restarts it
 doqueue -- sends qmail-send ALRM, scheduling queued messages for delivery
  reload -- sends qmail-send HUP, rereading locals and virtualdomains
   queue -- shows status of queue
    alrm -- same as doqueue
   flush -- same as doqueue
     hup -- same as reload
    kill -- svc -d processes in svclist, the do 'killall -KILL '
HELP
    ;;
  kill)
    echo "First stopping services ... "
    for svc in $svclist ; do
        if svok /service/$svc ; then
            svc -d /service/$svc
        fi
    done
    echo "Now sending processes the kill signal ... "
    killall -KILL apache2 php-fpm
    echo "done"
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|doqueue|flush|reload|stat|pause|cont|cdb|queue|help|clear|kill}"
    exit 1
    ;;
esac

exit 0
